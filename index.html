<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nova Web IDE — Lightweight In-Browser Editor</title>
    <style>
        :root{
            --bg:#0f1720; --panel:#0b1220; --muted:#9aa6b2; --accent:#58a6ff; --accent-2:#7c5cff; --success:#22c55e; --danger:#ff6b6b; --glass:rgba(255,255,255,0.03);
            --radius:10px; --mono: 'Fira Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, 'Segoe UI Mono', monospace;
        }
        html,body{height:100%; margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:linear-gradient(180deg,var(--bg),#071019); color:#e6eef4}
        .app{display:flex; height:100vh; gap:18px; padding:18px; box-sizing:border-box}
        .sidebar{width:260px; background:linear-gradient(180deg,var(--panel),#071229); border-radius:var(--radius); padding:14px; box-shadow:0 8px 30px rgba(2,6,23,0.7); display:flex; flex-direction:column}
        .brand{font-weight:700; letter-spacing:0.6px; font-size:16px; display:flex; align-items:center; gap:10px}
        .logo{width:36px; height:36px; background:linear-gradient(135deg,var(--accent),var(--accent-2)); border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:700}
        .files{margin-top:14px; flex:1; overflow:auto}
        .file{padding:8px 10px; border-radius:8px; cursor:pointer; color:var(--muted); display:flex; justify-content:space-between; align-items:center}
        .file.active{background:var(--glass); color:var(--accent)}
        .toolbar{display:flex; gap:8px; margin-top:12px}
        .btn{background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); padding:8px 10px; border-radius:8px; cursor:pointer}
        .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#041025; border:none}
        .main{flex:1; display:flex; flex-direction:column; gap:14px}
        .topbar{display:flex; align-items:center; gap:12px}
        .title{font-size:18px; font-weight:600}
        .editor-panel{flex:1; display:flex; gap:14px}
        .editor{flex:1; border-radius:10px; overflow:hidden; background:#071525; display:flex; flex-direction:column; box-shadow:0 8px 30px rgba(2,6,23,0.6)}
        .tabs{display:flex; gap:8px; padding:10px; border-bottom:1px solid rgba(255,255,255,0.02)}
        .tab{padding:6px 10px; border-radius:7px; color:var(--muted); cursor:pointer}
        .tab.active{background:rgba(255,255,255,0.03); color:var(--accent)}
        .code{flex:1; display:flex; gap:10px; padding:12px}
        textarea#editor{flex:1; resize:vertical; min-height:300px; height:520px; background:transparent; color:#e6eef4; border:none; outline:none; padding:12px; font-family:var(--mono); font-size:13px; line-height:1.5}
        .sidebar-doc{width:380px; background:linear-gradient(180deg,#06121a,#051019); border-radius:10px; padding:12px; box-shadow:0 6px 18px rgba(2,6,23,0.6)}
        .terminal{height:220px; background:#071224; padding:12px; border-radius:10px; font-family:var(--mono); font-size:13px; color:#dff1ff; overflow:auto; white-space:pre-wrap}
        .controls{display:flex; gap:8px; align-items:center}
        .small{font-size:12px; color:var(--muted)}
        .kbd{background:rgba(255,255,255,0.03); padding:4px 8px; border-radius:6px; color:var(--muted); font-family:var(--mono); font-size:12px}
        .palette{position:fixed; left:50%; top:18%; transform:translateX(-50%); width:720px; max-width:92%; background:#05151b; border-radius:12px; padding:12px; box-shadow:0 20px 60px rgba(0,0,0,0.7); display:none; z-index:80}
        .palette input{width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:transparent; color:#e6eef4}
        .palette-list{max-height:240px; overflow:auto; margin-top:8px}
        .palette-item{padding:8px;border-radius:8px;cursor:pointer;color:var(--muted)}
        .palette-item:hover{background:rgba(255,255,255,0.02); color:var(--accent)}
        .footer{display:flex; justify-content:space-between; align-items:center; padding:8px 6px; color:var(--muted); font-size:13px}
        .meta{display:flex; gap:8px; align-items:center}
        .example-list{display:flex; flex-direction:column; gap:8px; margin-top:10px}
        .example{padding:8px; border-radius:8px; background:rgba(255,255,255,0.02); cursor:pointer; color:var(--muted)}
        .muted{color:var(--muted)}
        /* small responsive tweaks */
        @media (max-width:980px){ .sidebar{display:none} .sidebar-doc{display:none} .app{padding:12px} }
    </style>
</head>
<body>
    <div class="app">
        <div class="sidebar">
            <div class="brand"><div class="logo">N</div>Nova Web IDE</div>
            <div class="small muted">Local in-browser environment — no server</div>
            <div class="files" id="fileList"></div>
            <div class="toolbar">
                <button class="btn" id="newFileBtn">New</button>
                <button class="btn" id="saveFileBtn">Save</button>
                <button class="btn" id="deleteFileBtn">Delete</button>
            </div>
            <div style="margin-top:12px">
                <div class="small muted">Quick actions</div>
                <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
                    <button class="btn" id="runBtnSmall">Run</button>
                    <button class="btn" id="clearTermBtn">Clear</button>
                    <button class="btn" id="examplesBtn">Examples</button>
                </div>
            </div>
        </div>

        <div class="main">
            <div class="topbar">
                <div class="title">Nova Web IDE</div>
                <div class="controls">
                    <div class="kbd">Ctrl+Enter</div>
                    <div class="kbd">Ctrl+S</div>
                    <div class="kbd">Ctrl+P</div>
                </div>
                <div style="flex:1"></div>
                <div class="small muted">Theme</div>
                <button class="btn" id="themeBtn">Toggle</button>
            </div>

            <div class="editor-panel">
                <div class="editor">
                    <div class="tabs" id="tabs"></div>
                    <div class="code">
                        <textarea id="editor" spellcheck="false" placeholder="Write Nova scripts here..."></textarea>
                    </div>
                    <div class="footer">
                        <div class="meta"> <span id="status">Ready</span> • <span class="muted" id="cursorPos">Ln 1, Col 1</span></div>
                        <div><button class="btn" id="formatBtn">Format</button> <button class="btn primary" id="runBtn">Run</button></div>
                    </div>
                </div>

                <div class="sidebar-doc">
                    <div style="display:flex; justify-content:space-between; align-items:center">
                        <div><strong>Terminal</strong></div>
                        <div class="small muted">Outputs & logs</div>
                    </div>
                    <div id="terminal" class="terminal"></div>
                    <div style="margin-top:10px"><strong>Canvas</strong></div>
                    <canvas id="novaCanvas" width="360" height="200" style="background:#000; border-radius:8px; margin-top:8px;"></canvas>
                    <div style="margin-top:10px"><strong>Examples</strong>
                        <div class="example-list" id="exampleList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="palette" id="palette">
        <input id="paletteInput" placeholder="Type a command, e.g. Run, Save, Load example..." />
        <div class="palette-list" id="paletteList"></div>
    </div>

    <script>
        // Utilities
        const el = (s, parent=document)=> parent.querySelector(s);
        const mk = (tag, attrs={})=> Object.assign(document.createElement(tag), attrs);
        function debounce(fn, wait=150){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }}

        // File management (localStorage)
        class FileManager{
            constructor(key='nova_files'){ this.key=key; this.files = this._load(); if(!this.files['untitled']) this.create('untitled', defaultScript()); }
            _load(){ try{ return JSON.parse(localStorage.getItem(this.key)||'{}'); }catch(e){ return {}; }}
            _save(){ localStorage.setItem(this.key, JSON.stringify(this.files)); }
            list(){ return Object.keys(this.files); }
            get(name){ return this.files[name]||''; }
            create(name, content=''){ let idx=1; let base=name; while(this.files[name]){ name=base+'_'+idx; idx++; } this.files[name]=content; this._save(); return name; }
            save(name, content){ this.files[name]=content; this._save(); }
            delete(name){ delete this.files[name]; this._save(); }
        }

        // Simple in-editor helpers
        function defaultScript(){ return `# Nova example: fibonacci\n# define a function and run it\ndefine fib:
        a is 0
        b is 1
        say "Fib sequence:"
        loop(10):
                say a
                tmp is a + b
                a is b
                b is tmp

run fib
`; }

        // Command Palette
        const commands = [
            {id:'run', title:'Run Current Script', run:()=>doRun()},
            {id:'save', title:'Save Current File', run:()=>saveCurrent()},
            {id:'new', title:'New File', run:()=>newFile()},
            {id:'clear', title:'Clear Terminal', run:()=>clearTerminal()},
            {id:'examples', title:'Show Examples', run:()=>showExamples()}
        ];

        // Editor + UI wiring
        const fm = new FileManager();
        let currentFile = fm.list()[0];
        const fileList = el('#fileList'); const editor = el('#editor'); const terminal = el('#terminal'); const tabs = el('#tabs'); const palette = el('#palette'); const paletteInput = el('#paletteInput'); const paletteList = el('#paletteList');

        function renderFileList(){ fileList.innerHTML=''; for(let f of fm.list()){ let div = mk('div'); div.className='file'+(f===currentFile?' active':''); div.textContent=f; div.onclick=()=>openFile(f); let del = mk('div'); del.style.opacity=0.5; del.textContent=''; div.appendChild(del); fileList.appendChild(div); }}
        function renderTabs(){ tabs.innerHTML=''; for(let f of fm.list()){ let t = mk('div'); t.className='tab'+(f===currentFile?' active':''); t.textContent=f; t.onclick=()=>openFile(f); tabs.appendChild(t);} }

        function openFile(name){ if(!fm.get(name)) return; currentFile=name; editor.value = fm.get(name); renderFileList(); renderTabs(); setStatus('Opened '+name); }
        function newFile(){ let name = fm.create('untitled', defaultScript()); openFile(name); }
        function saveCurrent(){ fm.save(currentFile, editor.value); setStatus('Saved '+currentFile); }
        function deleteCurrent(){ if(confirm('Delete '+currentFile+'?')){ fm.delete(currentFile); let list=fm.list(); currentFile=list[0]||fm.create('untitled', defaultScript()); openFile(currentFile);} }

        // Terminal helpers
        function println(msg, type='log'){ const line = document.createElement('div'); line.textContent = msg; if(type==='err') line.style.color='var(--danger)'; if(type==='ok') line.style.color='var(--success)'; terminal.appendChild(line); terminal.scrollTop = terminal.scrollHeight; }
        function clearTerminal(){ terminal.innerHTML=''; }
        function setStatus(text){ el('#status').textContent = text; }

        // Populate examples
        const exampleList = el('#exampleList');
        const EXAMPLES = {
            'Fibonacci': defaultScript(),
            'Counter': `# Count up to 5\ndefine cnt:\n    i is 0\n    loop(5):\n        say i\n        i is i + 1\nrun cnt\n`,
            'Ask Name': `say "What's your name?"\nask 'Enter name:'\nsay input\n`,
            'If/Else': `random_int 1,10,num\nif num > 5:\n    say "Number is greater than 5"\nelse:\n    say "Number is 5 or less"\nsay num\n`,
            'Pixel Drawing': `pixel 10,10,"red"\npixel 11,10,"red"\npixel 12,10,"red"\npixel 10,11,"blue"\npixel 11,11,"blue"\npixel 12,11,"blue"\n`,
            'Math Functions': `import time\nstart is time.now()\nnum is 16\nsqrt num\nsay "Square root of 16 is: "\nsay num\nend is time.now()\ndiff is end - start\nsay "Time taken: "\nsay diff\n`,
            'String Operations': `name is "hello world"\nupper name\nsay name\nlen name\nsay "Length: "\nsay name\n`
        };
        function renderExamples(){ exampleList.innerHTML=''; for(let k in EXAMPLES){ let d = mk('div'); d.className='example'; d.textContent=k; d.onclick=()=>{ editor.value = EXAMPLES[k]; setStatus('Loaded example '+k); }; exampleList.appendChild(d);} }

        // Keyboard shortcuts
        window.addEventListener('keydown', (e)=>{
            if((e.ctrlKey||e.metaKey) && e.key === 'Enter'){ e.preventDefault(); doRun(); }
            if((e.ctrlKey||e.metaKey) && e.key.toLowerCase() === 's'){ e.preventDefault(); saveCurrent(); }
            if((e.ctrlKey||e.metaKey) && e.key.toLowerCase() === 'p'){ e.preventDefault(); togglePalette(true); }
            if(e.key === 'Escape') togglePalette(false);
        });

        // Palette wiring
        function togglePalette(show){ if(show){ palette.style.display='block'; paletteInput.focus(); paletteInput.select(); updatePalette(''); } else palette.style.display='none'; }
        paletteInput.addEventListener('input', debounce(()=> updatePalette(paletteInput.value), 60));
        function updatePalette(q){ paletteList.innerHTML=''; const lower=q.toLowerCase(); for(let c of commands.filter(x=>x.title.toLowerCase().includes(lower) || x.id.includes(lower))){ let it = mk('div'); it.className='palette-item'; it.textContent = c.title; it.onclick = ()=>{ c.run(); togglePalette(false); }; paletteList.appendChild(it); } }

        // Formatting helper (basic auto-indentation)
        function formatCode(src){ // normalize indentation, add auto-indentation
            let lines = src.split(/\r?\n/).map(l=>l.replace(/[ \t]+$/,''));
            let formatted = [];
            let indentLevel = 0;
            const indentSize = 4;
            for(let line of lines){
                let trimmed = line.trim();
                if(!trimmed || trimmed.startsWith('#')) {
                    formatted.push(line);
                    continue;
                }
                // Decrease indent for certain keywords
                if(trimmed.startsWith('run ') || trimmed.startsWith('otherwise:') || trimmed === 'stop' || trimmed === 'clear') {
                    indentLevel = Math.max(0, indentLevel - 1);
                }
                // Add indentation
                let indented = ' '.repeat(indentLevel * indentSize) + trimmed;
                formatted.push(indented);
                // Increase indent after certain keywords
                if(trimmed.startsWith('define ') || trimmed.startsWith('loop') || trimmed.startsWith('check ') || trimmed.startsWith('otherwise:')) {
                    indentLevel += 1;
                }
            }
            return formatted.join('\n');
        }

        // Nova interpreter (extended)
        class NovaError extends Error{ constructor(msg,line=0){ super(msg); this.line=line; } }

        class ExpressionParser {
            constructor(local={}, globals={}){ this.local=local; this.globals=globals; }
            tokenize(expr){ 
                if(expr===undefined||expr===null) return []; 
                expr = String(expr);
                // support function calls like random.randint(1,10)
                const tokens = expr.match(/[A-Za-z_]\w*(?:\.\w+)*\(.*?\)|[A-Za-z_]\w*(?:\.\w+)*|\d+\.\d+|\d+|==|!=|<=|>=|[\+\-\*\/\(\)\[\],<>]/g) || [];
                return tokens.map(t=> this._parseToken(t));
            }
            _parseToken(t){ 
                if(/^\d+\.\d+$/.test(t)) return parseFloat(t); 
                if(/^\d+$/.test(t)) return parseInt(t); 
                if(this.local && this.local[t]!==undefined) return this.local[t]; 
                if(this.globals && this.globals[t]!==undefined) return this.globals[t]; 
                // handle module.function
                if(t.includes('.')){
                    const parts = t.split('.');
                    let obj = this.local && this.local[parts[0]] || this.globals && this.globals[parts[0]];
                    for(let i=1; i<parts.length; i++){
                        if(obj && typeof obj === 'object') obj = obj[parts[i]];
                        else return t; // fallback
                    }
                    return obj;
                }
                return t; 
            }
            // Shunting-yard simplified for + - * / and comparisons
            toRPN(tokens){ const prec = {'+':1,'-':1,'*':2,'/':2,'<':0,'>':0,'==':0,'!=':0,'<=':0,'>=':0}; let out=[], ops=[];
                for(let t of tokens){ if(typeof t === 'number' || typeof t === 'string' && !/[+\-*/<>=(),\[\]]/.test(t)) out.push(t);
                    else if('+-*/<>!='.includes(String(t)[0])){ while(ops.length && prec[ops[ops.length-1]]>=prec[t]) out.push(ops.pop()); ops.push(t); }
                    else if(t==='(') ops.push(t); else if(t===')'){ while(ops.length && ops[ops.length-1] !== '(') out.push(ops.pop()); ops.pop(); }
                }
                while(ops.length) out.push(ops.pop()); return out;
            }
            evalRPN(rpn){ let s=[]; for(let t of rpn){ if(typeof t === 'number' || typeof t === 'string' && !/[+\-*/<>=]/.test(String(t))){ s.push(t); } else { let b=s.pop(), a=s.pop(); switch(t){ case '+': s.push(a+b); break; case '-': s.push(a-b); break; case '*': s.push(a*b); break; case '/': s.push(a/b); break; case '<': s.push(a<b); break; case '>': s.push(a>b); break; case '==': s.push(a==b); break; case '!=': s.push(a!=b); break; case '<=': s.push(a<=b); break; case '>=': s.push(a>=b); break; default: throw new NovaError('Unknown operator '+t); } } } return s[0]; }
            parse(expr){ const t=this.tokenize(expr); const r=this.toRPN(t); return this.evalRPN(r); }
        }

        class NovaInterpreter{
            constructor(outputEl){ 
                this.terminal=outputEl; 
                this.functions={}; 
                this.globals={};
                this.modules = {};
                this.running=false;
                this.canvas = el('#novaCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.initModules();
            }
            initModules(){
                this.modules['time'] = {
                    now: () => Date.now(),
                    sleep: (ms) => new Promise(resolve => setTimeout(resolve, ms))
                };
                this.modules['random'] = {
                    randint: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min,
                    random: () => Math.random(),
                    choice: (arr) => arr[Math.floor(Math.random() * arr.length)]
                };
            }
            async run(code){ this.running=true; const lines = code.split(/\r?\n/); try{ await this._execute(lines); }catch(e){ println('Interpreter error: '+e.message,'err'); } this.running=false; }
            async _execute(lines, local={}){
                for(let i=0;i<lines.length;i++){
                    let raw = lines[i]; let line = raw.trim(); if(!line || line.startsWith('#')) continue;
                    // import
                    if(line.startsWith('import ')){
                        const mod = line.slice(7).trim();
                        if(this.modules[mod]){
                            local[mod] = this.modules[mod];
                        } else {
                            throw new NovaError('Unknown module: '+mod, i+1);
                        }
                        continue;
                    }
                    // function definition - stricter: require :
                    if(line.startsWith('define ')){
                        if(!line.includes(':')) throw new NovaError('Missing : after define', i+1);
                        const name = line.slice(7).replace(':','').trim(); const body=[]; i++; 
                        while(i<lines.length && (lines[i].startsWith('    ')||lines[i].startsWith('\t'))){ 
                            body.push(lines[i].replace(/^\s{1,4}/,'')); i++; 
                        } 
                        this.functions[name]=body; i--; continue;
                    }
                    // run function
                    if(line.startsWith('run ')){
                        const name = line.slice(4).trim(); if(!this.functions[name]) throw new NovaError('Unknown function '+name,i+1); await this._execute(this.functions[name], {...local}); continue;
                    }
                    // assignment: <var> is <expr>
                    if(line.includes(' is ')){
                        const [lhs, rhs] = line.split(' is ').map(s=>s.trim()); 
                        if(rhs.startsWith('ask')){ 
                            const q=rhs.slice(3).trim().replace(/^['\"]|['\"]$/g,''); 
                            local[lhs]=prompt(q); 
                        } else if(rhs.startsWith('input')) {
                            local[lhs] = local['input'] || '';
                        } else{ 
                            const p=new ExpressionParser(local,this.globals); 
                            local[lhs]=p.parse(rhs); 
                        } 
                        continue;
                    }
                    // say
                    if(line.startsWith('say ')){
                        const arg=line.slice(4).trim(); 
                        if(/^['\"].*['\"]$/.test(arg)) println(arg.slice(1,-1)); 
                        else if(local[arg]!==undefined) println(local[arg]); 
                        else println(arg); 
                        continue;
                    }
                    // ask
                    if(line.startsWith('ask ')){ 
                        const q=line.slice(4).trim().replace(/^['\"]|['\"]$/g,''); 
                        local['input']=prompt(q); 
                        continue; 
                    }
                    // loop - stricter: require :
                    if(line.startsWith('loop(') || line.startsWith('loop ')){
                        if(!line.includes('):') && !line.endsWith(':')) throw new NovaError('Missing : after loop', i+1);
                        const m=line.match(/loop(?:\(([^)]+)\))?/); 
                        const countExpr = m && m[1] ? m[1] : null; 
                        const blk=[]; i++; 
                        while(i<lines.length && (lines[i].startsWith('    ')||lines[i].startsWith('\t'))){ 
                            blk.push(lines[i].replace(/^\s{1,4}/,'')); i++; 
                        } 
                        if(countExpr === null){ 
                            await this._execute(blk,{...local});
                        } else { 
                            const p=new ExpressionParser(local,this.globals); 
                            const count = p.parse(countExpr);
                            for(let k=0;k<count;k++) await this._execute(blk,local);  // Changed: pass local instead of {...local} to allow accumulation
                        }
                        i--; continue;
                    }
                    // if/else
                    if(line.startsWith('if ')){
                        if(!line.includes(':')) throw new NovaError('Missing : after if', i+1);
                        const cond=line.slice(3).replace(':','').trim(); 
                        const p=new ExpressionParser(local,this.globals); 
                        const ok=p.parse(cond); 
                        const blk=[]; i++; 
                        while(i<lines.length && (lines[i].startsWith('    ')||lines[i].startsWith('\t'))){ 
                            blk.push(lines[i].replace(/^\s{1,4}/,'')); i++; 
                        }
                        if(ok) await this._execute(blk,{...local}); 
                        // check for else
                        if(i<lines.length && lines[i].trim().startsWith('else:')){ 
                            const oblk=[]; i++; 
                            while(i<lines.length && (lines[i].startsWith('    ')||lines[i].startsWith('\t'))){ 
                                oblk.push(lines[i].replace(/^\s{1,4}/,'')); i++; 
                            } 
                            if(!ok) await this._execute(oblk,{...local}); 
                        }
                        i--; continue;
                    }
                    // pixel drawing
                    if(line.startsWith('pixel ')){
                        const args = line.slice(6).trim().split(',').map(a=>a.trim());
                        if(args.length >= 3){
                            const x = parseInt(args[0]), y = parseInt(args[1]), color = args[2];
                            this.ctx.fillStyle = color;
                            this.ctx.fillRect(x, y, 1, 1);
                        }
                        continue;
                    }
                    if(line === 'clear_canvas'){
                        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                        continue;
                    }
                    // hundreds of commands
                    if(line.startsWith('print ')){ // alias for say
                        const arg=line.slice(6).trim(); 
                        if(/^['\"].*['\"]$/.test(arg)) println(arg.slice(1,-1)); 
                        else if(local[arg]!==undefined) println(local[arg]); 
                        else println(arg); 
                        continue;
                    }
                    if(line.startsWith('add ')){
                        const args = line.slice(4).trim().split(',').map(a=>a.trim());
                        if(args.length === 3){
                            const p=new ExpressionParser(local,this.globals);
                            local[args[2]] = p.parse(args[0]) + p.parse(args[1]);
                        }
                        continue;
                    }
                    if(line.startsWith('sub ')){
                        const args = line.slice(4).trim().split(',').map(a=>a.trim());
                        if(args.length === 3){
                            const p=new ExpressionParser(local,this.globals);
                            local[args[2]] = p.parse(args[0]) - p.parse(args[1]);
                        }
                        continue;
                    }
                    if(line.startsWith('mul ')){
                        const args = line.slice(4).trim().split(',').map(a=>a.trim());
                        if(args.length === 3){
                            const p=new ExpressionParser(local,this.globals);
                            local[args[2]] = p.parse(args[0]) * p.parse(args[1]);
                        }
                        continue;
                    }
                    if(line.startsWith('div ')){
                        const args = line.slice(4).trim().split(',').map(a=>a.trim());
                        if(args.length === 3){
                            const p=new ExpressionParser(local,this.globals);
                            local[args[2]] = p.parse(args[0]) / p.parse(args[1]);
                        }
                        continue;
                    }
                    if(line.startsWith('sqrt ')){
                        const arg = line.slice(5).trim();
                        const p=new ExpressionParser(local,this.globals);
                        local[arg] = Math.sqrt(p.parse(arg));
                        continue;
                    }
                    if(line.startsWith('pow ')){
                        const args = line.slice(4).trim().split(',').map(a=>a.trim());
                        if(args.length === 3){
                            const p=new ExpressionParser(local,this.globals);
                            local[args[2]] = Math.pow(p.parse(args[0]), p.parse(args[1]));
                        }
                        continue;
                    }
                    if(line.startsWith('sin ')){
                        const arg = line.slice(4).trim();
                        const p=new ExpressionParser(local,this.globals);
                        local[arg] = Math.sin(p.parse(arg));
                        continue;
                    }
                    if(line.startsWith('cos ')){
                        const arg = line.slice(4).trim();
                        const p=new ExpressionParser(local,this.globals);
                        local[arg] = Math.cos(p.parse(arg));
                        continue;
                    }
                    if(line.startsWith('tan ')){
                        const arg = line.slice(4).trim();
                        const p=new ExpressionParser(local,this.globals);
                        local[arg] = Math.tan(p.parse(arg));
                        continue;
                    }
                    if(line.startsWith('abs ')){
                        const arg = line.slice(4).trim();
                        const p=new ExpressionParser(local,this.globals);
                        local[arg] = Math.abs(p.parse(arg));
                        continue;
                    }
                    if(line.startsWith('floor ')){
                        const arg = line.slice(5).trim();
                        const p=new ExpressionParser(local,this.globals);
                        local[arg] = Math.floor(p.parse(arg));
                        continue;
                    }
                    if(line.startsWith('ceil ')){
                        const arg = line.slice(5).trim();
                        const p=new ExpressionParser(local,this.globals);
                        local[arg] = Math.ceil(p.parse(arg));
                        continue;
                    }
                    if(line.startsWith('round ')){
                        const arg = line.slice(6).trim();
                        const p=new ExpressionParser(local,this.globals);
                        local[arg] = Math.round(p.parse(arg));
                        continue;
                    }
                    if(line.startsWith('len ')){
                        const arg = line.slice(4).trim();
                        const p=new ExpressionParser(local,this.globals);
                        const val = p.parse(arg);
                        local[arg] = val.length || 0;
                        continue;
                    }
                    if(line.startsWith('upper ')){
                        const arg = line.slice(6).trim();
                        const p=new ExpressionParser(local,this.globals);
                        const val = p.parse(arg);
                        local[arg] = String(val).toUpperCase();
                        continue;
                    }
                    if(line.startsWith('lower ')){
                        const arg = line.slice(6).trim();
                        const p=new ExpressionParser(local,this.globals);
                        const val = p.parse(arg);
                        local[arg] = String(val).toLowerCase();
                        continue;
                    }
                    if(line.startsWith('concat ')){
                        const args = line.slice(7).trim().split(',').map(a=>a.trim());
                        if(args.length >= 2){
                            const p=new ExpressionParser(local,this.globals);
                            let result = '';
                            for(let a of args.slice(0,-1)){
                                result += String(p.parse(a));
                            }
                            local[args[args.length-1]] = result;
                        }
                        continue;
                    }
                    if(line.startsWith('wait ')){
                        const ms = line.slice(5).trim();
                        const p=new ExpressionParser(local,this.globals);
                        await new Promise(resolve => setTimeout(resolve, p.parse(ms)));
                        continue;
                    }
                    if(line.startsWith('random_int ')){
                        const args = line.slice(11).trim().split(',').map(a=>a.trim());
                        if(args.length === 3){
                            const p=new ExpressionParser(local,this.globals);
                            const min = p.parse(args[0]), max = p.parse(args[1]);
                            local[args[2]] = Math.floor(Math.random() * (max - min + 1)) + min;
                        }
                        continue;
                    }
                    if(line.startsWith('random_float ')){
                        const arg = line.slice(13).trim();
                        local[arg] = Math.random();
                        continue;
                    }
                    if(line.startsWith('time_now ')){
                        const arg = line.slice(9).trim();
                        local[arg] = Date.now();
                        continue;
                    }
                    // simple commands
                    if(line==='clear'){ clearTerminal(); continue; }
                    if(line==='clear_canvas'){ this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height); continue; }
                    if(line==='stop'){ println('Stop requested'); break; }
                    // fallback
                    throw new NovaError('Unknown command: '+line,i+1);
                }
            }
        }

        // Actions
        async function doRun(){ clearTerminal(); setStatus('Running'); const nova = new NovaInterpreter(terminal); try{ await nova.run(editor.value); setStatus('Finished'); }catch(e){ println('Runtime error: '+e.message,'err'); setStatus('Error'); } }

        // Wire UI buttons
        el('#runBtn').addEventListener('click', doRun);
        el('#runBtnSmall').addEventListener('click', doRun);
        el('#saveFileBtn').addEventListener('click', saveCurrent);
        el('#newFileBtn').addEventListener('click', newFile);
        el('#deleteFileBtn').addEventListener('click', ()=>{ deleteCurrent(); renderFileList(); renderTabs(); });
        el('#clearTermBtn').addEventListener('click', clearTerminal);
        el('#examplesBtn').addEventListener('click', showExamples);
        el('#formatBtn').addEventListener('click', ()=>{ editor.value = formatCode(editor.value); setStatus('Formatted'); });
        el('#themeBtn').addEventListener('click', ()=>{ document.documentElement.classList.toggle('dark'); setStatus('Theme toggled'); });

        // Simple save as file
        function download(filename, text){ const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([text], {type:'text/plain'})); a.download = filename; document.body.appendChild(a); a.click(); a.remove(); }
        el('#saveFileBtn').addEventListener('dblclick', ()=> download(currentFile+'.nova', editor.value));

        // Palette keyboard
        el('#paletteInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ const pick = commands.find(c=>c.title.toLowerCase().includes(paletteInput.value.toLowerCase())); if(pick) pick.run(); togglePalette(false); } });

        // Examples display
        function showExamples(){ renderExamples(); setStatus('Examples loaded'); }

        // initial render
        renderExamples(); renderFileList(); renderTabs(); openFile(currentFile);

        // Keep cursor info updated
        editor.addEventListener('keyup', debounce(()=>{ const pos = editor.selectionStart; const before = editor.value.slice(0,pos); const ln = before.split(/\r?\n/).length; const col = before.split(/\r?\n/).pop().length + 1; el('#cursorPos').textContent = `Ln ${ln}, Col ${col}`; },80));

        // expose for console during debugging
        window.NovaIDE = { fm, doRun, saveCurrent, newFile, clearTerminal };
    </script>
</body>
</html>
